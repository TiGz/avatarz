<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Avatarz</title>
  </head>
  <body>
    <div id="root"></div>
    <script>
      // Handle Supabase auth callback before React loads
      // Supports both #access_token= and #/access_token= formats (HashRouter compat)
      // Uses sessionStorage to pass tokens to React, which calls setSession() properly
      (function() {
        var hash = window.location.hash;
        console.log('[PreAuth] Checking hash:', hash ? hash.substring(0, 50) + '...' : 'none');

        if (hash && hash.includes('access_token=')) {
          console.log('[PreAuth] Auth tokens detected in URL');

          // Remove leading #/, #/#, or # to get params
          // Handles: #access_token, #/access_token, #/#access_token (double hash from redirectTo)
          var paramStr = hash.replace(/^#\/?#?/, '');
          var params = new URLSearchParams(paramStr);
          var accessToken = params.get('access_token');
          var refreshToken = params.get('refresh_token');

          if (accessToken && refreshToken) {
            console.log('[PreAuth] Valid tokens found, storing in sessionStorage');

            // Store tokens in sessionStorage for React app to process via setSession()
            // This ensures Supabase SDK properly establishes the session with user data
            sessionStorage.setItem('pending-auth-tokens', JSON.stringify({
              access_token: accessToken,
              refresh_token: refreshToken
            }));

            // Clean redirect to app root (removes auth params from URL)
            console.log('[PreAuth] Redirecting to clean URL');
            window.location.replace(window.location.pathname + '#/');
          } else {
            console.log('[PreAuth] Missing access_token or refresh_token');
          }
        }
      })();
    </script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
